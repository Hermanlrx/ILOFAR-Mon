<!DOCTYPE html>
<html>
<head>
    <title>ILOFAR Dynamic Spectrogram</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        #plot { 
            width: 100%; 
            height: 800px; 
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #2a2a2a;
            border-radius: 5px;
        }
        .control-group {
            margin: 10px 0;
        }
        label {
            display: inline-block;
            width: 150px;
        }
        input[type="number"] {
            padding: 5px;
            width: 100px;
            background: #3a3a3a;
            color: #fff;
            border: 1px solid #555;
            border-radius: 3px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #357abd; }
        .info {
            margin: 10px 0;
            padding: 10px;
            background: #2a2a2a;
            border-left: 3px solid #4a90e2;
            font-size: 14px;
        }
        select {
            padding: 5px;
            background: #3a3a3a;
            color: #fff;
            border: 1px solid #555;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>ILOFAR Mode 357 Spectrogram Viewer</h1>
    
    <div id="info" class="info">Loading data...</div>
    
    <div class="controls">
        <div class="control-group">
            <label>Start Time (minutes):</label>
            <input type="number" id="startMin" value="0" min="0" step="1">
        </div>
        <div class="control-group">
            <label>Duration (minutes):</label>
            <input type="number" id="duration" value="60" min="1" step="1" max="120">
        </div>
        <div class="control-group">
            <label>Colormap:</label>
            <select id="colormap">
                <option value="Plasma">Plasma</option>
                <option value="Inferno">Inferno</option>
                <option value="Viridis">Viridis</option>
                <option value="Hot">Hot</option>
                <option value="Jet">Jet</option>
            </select>
        </div>
        <div class="control-group">
            <label>Gamma:</label>
            <input type="number" id="gamma" value="0.9" min="0.1" max="2" step="0.05">
        </div>
        <button onclick="updatePlot()">Update Plot</button>
        <button onclick="resetView()">Reset View</button>
    </div>
    
    <div id="plot"></div>
    
    <script>
        let spectrogramData = null;
        
        // Load JSON data
        async function loadData() {
            try {
                const response = await fetch('./spectrogram.json');
                spectrogramData = await response.json();
                
                const meta = spectrogramData.metadata;
                const info = document.getElementById('info');
                info.innerHTML = `
                    <strong>File:</strong> ${meta.original_file} | 
                    <strong>Start:</strong> ${new Date(meta.start_time).toISOString()} | 
                    <strong>Duration:</strong> ${(meta.duration_seconds / 60).toFixed(1)} min | 
                    <strong>Samples:</strong> ${meta.num_time_samples}
                `;
                
                // Set max duration
                document.getElementById('duration').max = Math.ceil(meta.duration_seconds / 60);
                
                console.log('Data loaded successfully');
                updatePlot();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('info').innerHTML = 
                    '<strong style="color: #ff6b6b;">Error loading data. Check console.</strong>';
            }
        }
        
        // Apply log scaling and flattening (matches your Python code)
        function processData(data) {
            const nFreq = data.length;
            const nTime = data[0].length;
            
            // Log scale
            const logData = data.map(row => 
                row.map(val => Math.log10(Math.max(val, 1e-10)))
            );
            
            // Replace -Inf with 0
            logData.forEach(row => {
                for (let i = 0; i < row.length; i++) {
                    if (!isFinite(row[i])) row[i] = 0;
                }
            });
            
            // Flatten: median across time for each frequency
            const flattened = logData.map(row => {
                const sorted = [...row].sort((a, b) => a - b);
                const median = sorted[Math.floor(sorted.length / 2)];
                const bg = median === 0 ? 1.0 : median;
                return row.map(val => val / bg);
            });
            
            return flattened;
        }
        
        // Apply power normalization (mimics PowerNorm from matplotlib)
        function applyPowerNorm(data, gamma) 
        {
            let vmin = Infinity;
            let vmax = -Infinity;

            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                for (let j = 0; j < row.length; j++) {
                    const v = row[j];
                    if (v < vmin) vmin = v;
                    if (v > vmax) vmax = v;
                }
            }

            const range = vmax - vmin || 1;

            return data.map(row =>
                row.map(val => {
                    const normalized = (val - vmin) / range;
                    return Math.pow(normalized, gamma);
                })
            );
        }
        
        function updatePlot() {
            if (!spectrogramData) return;
            
            const startMin = parseFloat(document.getElementById('startMin').value);
            const duration = parseFloat(document.getElementById('duration').value);
            const colormap = document.getElementById('colormap').value;
            const gamma = parseFloat(document.getElementById('gamma').value);
            
            const times = spectrogramData.timestamps.map(t => new Date(t));
            
            // Calculate time indices
            const i0 = Math.floor(startMin * 60);
            const i1 = Math.min(i0 + Math.floor(duration * 60), times.length);
            
            // Create subplots for 3 bands
            const traces = [];
            const bands = spectrogramData.bands;
            
            // Calculate height ratios
            const bw3 = bands[0].freq_range[1] - bands[0].freq_range[0];
            const bw5 = bands[1].freq_range[1] - bands[1].freq_range[0];
            const bw7 = bands[2].freq_range[1] - bands[2].freq_range[0];
            const totalBw = bw3 + bw5 + bw7;
            const ratios = [bw3/totalBw, bw5/totalBw, bw7/totalBw];
            
            bands.forEach((band, idx) => {
                // Slice data (no decompression needed - data is already arrays)
                const slicedData = band.data.map(row => row.slice(i0, i1));
                
                // Process: log + flatten
                let processed = processData(slicedData);
                
                // Apply power norm
                processed = applyPowerNorm(processed, gamma);
                
                traces.push({
                    z: processed,
                    x: times.slice(i0, i1),
                    y: band.frequencies,
                    type: 'heatmap',
                    colorscale: colormap,
                    colorbar: idx === 2 ? {
                        title: 'Intensity',
                        x: 1.02,
                        len: ratios[2]
                    } : { showscale: false },
                    xaxis: `x${idx + 1}`,
                    yaxis: `y${idx + 1}`,
                    hovertemplate: '<b>%{y:.2f} MHz</b><br>%{x|%H:%M:%S}<br>I: %{z:.3f}<extra></extra>'
                });
            });
            
            // Layout with proportional heights
            const layout = {
                title: {
                    text: `ILOFAR Mode 357 - ${times[i0].toISOString().split('T')[1].slice(0, 5)} to ${times[i1-1].toISOString().split('T')[1].slice(0, 5)} UTC`,
                    font: { size: 16 }
                },
                grid: {
                    rows: 3,
                    columns: 1,
                    pattern: 'independent',
                    roworder: 'top to bottom',
                    subplots: [['xy'], ['xy2'], ['xy3']],
                    ygap: 0.05
                },
                xaxis: { title: '', showticklabels: false, domain: [0, 0.95] },
                yaxis: { title: 'Mode 3 (MHz)', 
                autorange:'reversed',
                domain: [0.67, 1.0] },

                xaxis2: { title: '', showticklabels: false, domain: [0, 0.95] },
                yaxis2: { title: 'Mode 5 (MHz)',
                autorange:'reversed', 
                domain: [0.34, 0.63] },

                xaxis3: { 
                    title: 'Time (UTC)',
                    domain: [0, 0.95],
                    tickformat: '%H:%M'
                },
                yaxis3: { title: 'Mode 7 (MHz)', 
                autorange:'reversed',
                domain: [0, 0.30] },

                plot_bgcolor: '#1a1a1a',
                paper_bgcolor: '#2a2a2a',
                font: { color: '#fff' },
                hovermode: 'closest',
                height: 800
            };
            
            const config = {
                responsive: true,
                displayModeBar: true,
                toImageButtonOptions: {
                    format: 'png',
                    filename: `ilofar_${startMin}min`,
                    height: 1000,
                    width: 1200
                }
            };
            
            Plotly.newPlot('plot', traces, layout, config);
        }
        
        function resetView() {
            document.getElementById('startMin').value = 0;
            document.getElementById('duration').value = 60;
            document.getElementById('gamma').value = 0.9;
            updatePlot();
        }
        
        // Load data on page load
        loadData();
    </script>
</body>
</html>