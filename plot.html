<!DOCTYPE html>
<html>
<head>
    <title>ILOFAR Dynamic Spectrogram</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        #plot { 
            width: 100%; 
            height: 720px; 
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #2a2a2a;
            border-radius: 5px;
        }
        .control-group {
            margin: 10px 0;
        }
        label {
            display: inline-block;
            width: 150px;
        }
        input, select {
            padding: 5px;
            background: #3a3a3a;
            color: #fff;
            border: 1px solid #555;
            border-radius: 3px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #357abd; }
        .info {
            margin: 10px 0;
            padding: 10px;
            background: #2a2a2a;
            border-left: 3px solid #4a90e2;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>ILOFAR Mode 357 Spectrogram Viewer</h1>
    
    <div id="info" class="info">Loading data...</div>
    
    <div class="controls">
        <div class="control-group">
            <label>Start Time (minutes):</label>
            <input type="number" id="startMin" value="0" min="0" step="1">
        </div>
        <div class="control-group">
            <label>Duration (minutes):</label>
            <input type="number" id="duration" value="60" min="1" step="1" max="120">
        </div>
        <div class="control-group">
            <label>Colormap:</label>
            <select id="colormap">
                <option value="Viridis">Viridis</option>
                <option value="Plasma">Plasma</option>
                <option value="Inferno">Inferno</option>
                <option value="Hot">Hot</option>
                <option value="Jet">Jet</option>
            </select>
        </div>
        <div class="control-group">
            <label>Gamma:</label>
            <input type="number" id="gamma" value="0.9" min="0.1" max="2" step="0.05">
        </div>
        <button onclick="updatePlot()">Update Plot</button>
        <button onclick="resetView()">Reset View</button>
    </div>
    
    <div id="plot"></div>
    
    <script>
        let spectrogramData = null;
        
        async function loadData() {
            try {
                const response = await fetch('./spectrogram.json');
                spectrogramData = await response.json();
                
                const meta = spectrogramData.metadata;
                document.getElementById('info').innerHTML = `
                    <strong>File:</strong> ${meta.original_file} | 
                    <strong>Start:</strong> ${new Date(meta.start_time).toISOString()} | 
                    <strong>Duration:</strong> ${(meta.duration_seconds / 60).toFixed(1)} min | 
                    <strong>Samples:</strong> ${meta.num_time_samples}
                `;
                
                document.getElementById('duration').max = Math.ceil(meta.duration_seconds / 60);
                updatePlot();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('info').innerHTML = 
                    '<strong style="color: #ff6b6b;">Error loading data. Check console.</strong>';
            }
        }
        
        function processData(data) {
            const logData = data.map(row => 
                row.map(val => Math.log10(Math.max(val, 1e-10)))
            );
            
            logData.forEach(row => {
                for (let i = 0; i < row.length; i++) {
                    if (!isFinite(row[i])) row[i] = 0;
                }
            });
            
            const flattened = logData.map(row => {
                const sorted = [...row].sort((a, b) => a - b);
                const median = sorted[Math.floor(sorted.length / 2)];
                const bg = median === 0 ? 1.0 : median;
                return row.map(val => val / bg);
            });
            
            return flattened;
        }
        
        function applyPowerNorm(data, vmin, vmax, gamma) {
            const range = vmax - vmin || 1;
            return data.map(row =>
                row.map(val => {
                    const clipped = Math.max(vmin, Math.min(vmax, val));
                    const normalized = (clipped - vmin) / range;
                    return Math.pow(normalized, gamma);
                })
            );
        }
        
        function updatePlot() {
            if (!spectrogramData) return;
            
            const startMin = parseFloat(document.getElementById('startMin').value);
            const duration = parseFloat(document.getElementById('duration').value);
            const colormap = document.getElementById('colormap').value;
            const gamma = parseFloat(document.getElementById('gamma').value);
            
            const times = spectrogramData.timestamps.map(t => new Date(t));
            const i0 = Math.floor(startMin * 60);
            const i1 = Math.min(i0 + Math.floor(duration * 60), times.length);
            
            const bands = spectrogramData.bands;
            const traces = [];
            
            const dividedBands = bands.map(band => {
                const sliced = band.data.map(row => row.slice(i0, i1));
                return processData(sliced);
            });
            
            // Use percentiles from Mode 3 only (like original matplotlib)
            const band3Flat = dividedBands[0].flat();
            band3Flat.sort((a,b) => a - b);
            const refVmin = band3Flat[Math.floor(band3Flat.length * 0.30)] ?? 0;
            const refVmax = band3Flat[Math.floor(band3Flat.length * 0.95)] ?? 1;
            
            const processedBands = dividedBands.map(divided => 
                applyPowerNorm(divided, refVmin, refVmax, gamma)
            );
            
            processedBands.forEach((zdata, idx) => {
                traces.push({
                    z: zdata,
                    x: times.slice(i0, i1),
                    y: bands[idx].frequencies,
                    type: 'heatmap',
                    colorscale: colormap,
                    zmin: 0,
                    zmax: 1,
                    zsmooth: false,
                    showscale: idx === 2,
                    colorbar: idx === 2 ? {
                        title: { text: 'Normalized Intensity', side: 'right' },
                        x: 1.02,
                        y: 0.5,
                        len: 0.92,
                        thickness: 20,
                        tickfont: { size: 11 }
                    } : undefined,
                    xaxis: `x${idx + 1}`,
                    yaxis: `y${idx + 1}`,
                    hovertemplate: '<b>%{y:.2f} MHz</b><br>%{x|%H:%M:%S}<br>I: %{z:.3f}<extra></extra>'
                });
            });
            
            const layout = {
                title: {
                    text: `ILOFAR Mode 357 - ${times[i0].toISOString().split('T')[1].slice(0,5)} to ${times[i1-1].toISOString().split('T')[1].slice(0,5)} UTC`,
                    font: { size: 16 }
                },
                xaxis:  { showticklabels: false, domain: [0, 0.96] },
                xaxis2: { showticklabels: false, domain: [0, 0.96] },
                xaxis3: { 
                    title: 'Time (UTC)',
                    tickformat: '%H:%M',
                    domain: [0, 0.96]
                },
                // Explicit domains with small gaps → 0.015–0.02 spacing
                yaxis:  { title: 'Mode 3 (MHz)', autorange: 'reversed', domain: [0.65, 1.000] }, // ~35
                yaxis2: { title: 'Mode 5 (MHz)', autorange: 'reversed', domain: [0.25, 0.60] }, // ~35%
                yaxis3: { title: 'Mode 7 (MHz)', autorange: 'reversed', domain: [0.000, 0.20] }, // ~20

                plot_bgcolor: '#1a1a1a',
                paper_bgcolor: '#2a2a2a',
                font: { color: '#fff' },
                hovermode: 'closest',
                height: 520,
                margin: { l: 65, r: 90, t: 50, b: 70 },
                grid: { rows: 3, columns: 1, pattern: 'independent' } // keep for reference, but domains dominate
            };
            
            Plotly.newPlot('plot', traces, layout);
        }
        
        function resetView() {
            document.getElementById('startMin').value = 0;
            document.getElementById('duration').value = 60;
            document.getElementById('gamma').value = 0.9;
            updatePlot();
        }
        
        loadData();
    </script>
</body>
</html>